<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administração - Evoluxo Barbearia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* Variáveis de Largura */
        :root {
            --sidebar-width-open: 250px;
            --sidebar-width-closed: 60px;
            --header-height: 60px;
            --content-padding: 20px;
        }

        /* CORREÇÕES GERAIS */
        html, body { overflow-x: hidden; }
        * { box-sizing: border-box; }
        .row { margin-left: 0 !important; margin-right: 0 !important; }

        /* LAYOUT */
        body {
            background-color: #f4f7f6;
            padding-top: var(--header-height);
            transition: margin-left 0.3s ease;
        }

        /* 1. SIDEBAR */
        #sidebar-wrapper {
            background-color: #343a40;
            color: white;
            width: var(--sidebar-width-closed);
            height: 100vh;
            position: fixed;
            top: 0; left: 0; z-index: 1002;
            transition: width 0.3s ease;
            overflow-x: hidden;
            padding-top: var(--header-height);
        }
        body.sidebar-open #sidebar-wrapper { width: var(--sidebar-width-open); }
        .sidebar-link { color: #adb5bd; padding: 10px 15px; text-decoration: none; display: flex; align-items: center; cursor: pointer; }
        .sidebar-link:hover, .sidebar-link.active-menu { background-color: #495057; color: white; }
        .sidebar-link i { font-size: 1.25rem; margin-right: 15px; min-width: 25px; }
        .sidebar-text { display: none; }
        body.sidebar-open .sidebar-text { display: inline; }
        #sidebar-title { position: absolute; top: 10px; left: 60px; color: #ffc107; opacity: 0; transition: opacity 0.3s ease; }
        body.sidebar-open #sidebar-title { opacity: 1; }

        /* 2. HEADER */
        #main-header {
            position: fixed; top: 0; height: var(--header-height);
            background-color: white; color: black; z-index: 999; padding: 0;
            border-bottom: 1px solid #dee2e6; transition: left 0.3s ease, width 0.3s ease;
        }
        #header-content {
            height: 100%; display: flex; align-items: center; justify-content: space-between;
            padding: 0 var(--content-padding); padding-left: calc(var(--sidebar-width-closed) + var(--content-padding));
        }
        #header-title { color: #ffc107; font-weight: 700; }

        /* 3. CONTEÚDO PRINCIPAL */
        .main-content {
            padding: var(--content-padding); padding-top: var(--content-padding);
            min-height: 100vh; padding-left: calc(var(--sidebar-width-closed) + var(--content-padding));
            overflow-x: hidden;
        }
        .content-section { display: none; }
        #dashboard-section { display: block; }

        /* Estilos de Cards */
        .card-ganhos, .card-corte { border-left: 5px solid; }
        .card-ganhos { background-color: #d4edda; color: #155724; border-color: #155724; }
        .card-corte { background-color: #cce5ff; color: #004085; border-color: #004085; }
        .text-huge { font-size: 2.5rem; font-weight: 700; }
        .cliente-link { cursor: pointer; text-decoration: underline; }

    </style>
</head>
<body>

<header id="main-header">
    <div id="header-content">
        <h3 id="header-title" class="mb-0">EVOLUXO ADMIN</h3>

        <div>
            <button class="btn btn-warning shadow-sm" data-bs-toggle="modal" data-bs-target="#modalNovoAgendamento" title="Agendar Novo Serviço">
                <i class="bi bi-plus-circle-fill"></i> Novo Agendamento
            </button>
        </div>
    </div>
</header>

<div id="sidebar-wrapper">
    <button class="btn btn-dark" id="menu-toggle" title="Abrir/Fechar Menu">
        <i class="bi bi-list"></i>
    </button>
    <ul class="nav flex-column">
        <li class="nav-item">
            <a class="sidebar-link active-menu" data-target="dashboard-section"><i class="bi bi-speedometer2"></i> <span class="sidebar-text">Dashboard</span></a>
        </li>
        <li class="nav-item">
            <a class="sidebar-link" data-target="agendamentos-section"><i class="bi bi-calendar-check"></i> <span class="sidebar-text">Agendamentos</span></a>
        </li>
        <li class="nav-item">
            <a class="sidebar-link" data-target="servicos-section"><i class="bi bi-tags"></i> <span class="sidebar-text">Serviços</span></a>
        </li>
        <li class="nav-item">
            <a class="sidebar-link" data-bs-toggle="modal" data-bs-target="#modalCadastroCliente">
                <i class="bi bi-person-plus"></i> <span class="sidebar-text">Cadastrar Cliente</span>
            </a>
        </li>
        <li class="nav-item">
            <a class="sidebar-link" data-target="fidelidade-section"><i class="bi bi-people"></i> <span class="sidebar-text">Clientes/Fidelidade</span></a>
        </li>
        <li class="nav-item">
            <a class="sidebar-link" href="#"><i class="bi bi-box-arrow-right"></i> <span class="sidebar-text">Sair</span></a>
        </li>
    </ul>
</div>


<main class="main-content" id="mainContent">
    <h2 class="mb-4" id="main-page-title">Dashboard de Gerenciamento</h2>

    <div id="dashboard-section" class="content-section">
        <div class="row mb-5">
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card card-ganhos h-100"><div class="card-body"><h5 class="card-title"><i class="bi bi-currency-dollar"></i> Ganhos do Mês (Dezembro)</h5><p class="text-huge">R$ 4.580,00</p><p class="card-text">Meta: +12% acima do mês passado.</p></div></div>
            </div>
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card card-corte h-100"><div class="card-body"><h5 class="card-title"><i class="bi bi-person-badge"></i> Clientes Próximos do Grátis</h5><p class="text-huge">15</p><p class="card-text">Incentive a fidelidade e marque o próximo corte.</p></div></div>
            </div>
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card bg-warning h-100"><div class="card-body"><h5 class="card-title"><i class="bi bi-calendar3"></i> Agendamentos de Hoje</h5><p class="text-huge text-dark">8</p><p class="card-text text-dark">Lembretes por WhatsApp enviados com sucesso.</p></div></div>
            </div>
        </div>
        <div class="card mb-5">
            <div class="card-header bg-primary text-white"><h5 class="mb-0">Agendamentos de Hoje: 02/Dez</h5></div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead><tr><th>Hora</th><th>Cliente</th><th>Serviço</th><th>Status</th><th>Ações</th></tr></thead>
                        <tbody>
                        <tr><td>10:00</td><td><span class="cliente-link" data-bs-toggle="modal" data-bs-target="#modalClienteDetalhes">Lucas Oliveira</span></td><td>Corte + Barba</td><td><span class="badge bg-success">Confirmado</span></td><td><button class="btn btn-sm btn-outline-primary" title="Marcar como Concluído"><i class="bi bi-check-lg"></i></button><button class="btn btn-sm btn-outline-danger" title="Cancelar Agendamento"><i class="bi bi-x-lg"></i></button></td></tr>
                        <tr><td>11:30</td><td><span class="cliente-link" data-bs-toggle="modal" data-bs-target="#modalClienteDetalhes">Mariana Silva</span></td><td>Platinado</td><td><span class="badge bg-warning text-dark">Pendente</span></td><td><button class="btn btn-sm btn-outline-primary" title="Marcar como Concluído"><i class="bi bi-check-lg"></i></button><button class="btn btn-sm btn-outline-danger" title="Cancelar Agendamento"><i class="bi bi-x-lg"></i></button></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="agendamentos-section" class="content-section"></div>
    <div id="servicos-section" class="content-section"></div>
    <div id="fidelidade-section" class="content-section"></div>


</main>


<div class="modal fade" id="modalCadastroCliente" tabindex="-1" aria-labelledby="modalCadastroClienteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalCadastroClienteLabel"><i class="bi bi-person-add"></i> Cadastrar Novo Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="position: relative; min-height: 300px;">

                <div id="loadingSpinnerCadastro" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); display: none; z-index: 1055; display: flex; justify-content: center; align-items: center; flex-direction: column;">
                    <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"><span class="visually-hidden">Salvando...</span></div>
                    <p class="mt-3 text-success">Salvando dados, aguarde...</p>
                </div>

                <div id="resultMessageCadastro" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: white; display: none; z-index: 1056; display: flex; justify-content: center; align-items: center; flex-direction: column; padding: 20px;">
                    <h3 id="messageTitle" class="text-center"></h3>
                    <p id="messageBody" class="mt-2 text-center"></p>
                </div>

                <form action="/cadastrar" method="POST" id="cadastroFormModal">
                    <div class="mb-3">
                        <label for="nomeClienteCadastro" class="form-label">Nome Completo</label>
                        <input type="text" class="form-control" id="nomeClienteCadastro" name="nome" required>
                    </div>
                    <div class="mb-3">
                        <label for="whatsappCadastro" class="form-label">WhatsApp (DDD + Número)</label>
                        <input type="tel" class="form-control" id="whatsappCadastro" placeholder="(99) 99999-9999" name="whatsapp" required>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">Salvar Cliente</button>
                    </div>
                </form>

            </div>
            <div class="modal-footer"><small class="text-muted">O cadastro iniciará a contagem de fidelidade.</small></div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNovoAgendamento" tabindex="-1" aria-labelledby="modalNovoAgendamentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark"><h5 class="modal-title" id="modalNovoAgendamentoLabel">Marcar Horário Interno</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>

            <div class="modal-body">
                <form id="agendamentoFormAdmin">
                    <div class="mb-3" style="position: relative;">
                        <label for="nomeClienteAdmin" class="form-label">Nome do Cliente</label>
                        <input type="text" class="form-control" id="nomeClienteAdmin" name="nome" placeholder="Digite o nome ou comece a digitar" required>

                        <div id="autocompleteResults" class="list-group position-absolute w-100 shadow" style="z-index: 2000; display: none;"></div>
                    </div>

                    <input type="hidden" id="whatsappClienteAgendamento" name="whatsapp_cliente">

                    <div class="mb-3">
                        <label for="servicoAdmin" class="form-label">Serviço</label>
                        <select class="form-select" id="servicoAdmin" name="servico" required>
                            <option selected disabled value="">Selecione...</option>
                            <option value="corte">Corte de Cabelo (R$ 40)</option>
                            <option value="barba">Barba Tradicional (R$ 35)</option>
                            <option value="gratis">Corte Grátis (Fidelidade)</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label for="dataAdmin" class="form-label">Data</label>
                            <input type="date" class="form-control" id="dataAdmin" name="data" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label for="horaAdmin" class="form-label">Hora</label>
                            <input type="time" class="form-control" id="horaAdmin" name="hora" min="09:00" max="18:00" required>
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" value="true" id="enviarNotificacao" name="notificacao" checked>
                        <label class="form-check-label" for="enviarNotificacao">Enviar confirmação via WhatsApp</label>
                    </div>
                    <button type="submit" class="btn btn-warning w-100">Confirmar Agendamento</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalClienteDetalhes" tabindex="-1" aria-labelledby="modalClienteDetalhesLabel" aria-hidden="true">
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {

        // =================================================================
        // 1. INICIALIZAÇÃO DE VARIÁVEIS E COMPONENTES
        // =================================================================
        const body = document.body;
        const menuToggle = document.getElementById('menu-toggle');
        const mainHeader = document.getElementById('main-header');
        const sidebarWidthClosed = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width-closed').trim();
        const sidebarLinks = document.querySelectorAll('.sidebar-link[data-target]');
        const contentSections = document.querySelectorAll('.content-section');
        const mainPageTitle = document.getElementById('main-page-title');

        // Modal de Cadastro (SPINNER)
        const modalElementCadastro = document.getElementById('modalCadastroCliente');
        const cadastroForm = document.getElementById('cadastroFormModal');
        const spinnerCadastro = document.getElementById('loadingSpinnerCadastro');
        const resultMessageDiv = document.getElementById('resultMessageCadastro');
        const messageTitle = document.getElementById('messageTitle');
        const messageBody = document.getElementById('messageBody');
        const modalCadastro = modalElementCadastro ? new bootstrap.Modal(modalElementCadastro) : null;

        // Modal de Agendamento (AUTOCOMPLETAR)
        const inputNomeCliente = document.getElementById('nomeClienteAdmin');
        const divResultados = document.getElementById('autocompleteResults');
        let searchTimeout;

        // Configurações de Tempo
        const TEMPO_ESPERA_SPINNER = 3000;
        const TEMPO_EXIBICAO_MENSAGEM = 2000;

        // Setup Autocompletar: Anexar resultados
        if (inputNomeCliente && divResultados && !divResultados.parentNode) {
            const parentDiv = inputNomeCliente.closest('.mb-3');
            if (parentDiv) {
                parentDiv.appendChild(divResultados);
            }
        }

        // --- FUNÇÕES DE NAVEGAÇÃO ---
        function navigateToSection(targetId, title) {
            contentSections.forEach(section => { section.style.display = 'none'; });
            const targetSection = document.getElementById(targetId);
            if (targetSection) { targetSection.style.display = 'block'; }
            mainPageTitle.textContent = title;
            sidebarLinks.forEach(link => {
                link.classList.remove('active-menu');
                if (link.getAttribute('data-target') === targetId) { link.classList.add('active-menu'); }
            });
        }
        function toggleSidebar() { /* Lógica de toggle sidebar */ }


        // =================================================================
        // 2. LÓGICA DO FORMULÁRIO DE CADASTRO (Spinner/Submit)
        // =================================================================

        if (cadastroForm && modalElementCadastro) {
            cadastroForm.addEventListener('submit', function(event) {
                event.preventDefault();

                const formData = new FormData(event.target);
                const params = new URLSearchParams(formData).toString();

                cadastroForm.style.display = 'none';
                spinnerCadastro.style.display = 'flex';
                const submitButton = cadastroForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                const startTime = Date.now();

                fetch('/cadastrar', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: params })
                .then(response => { return Promise.all([response.ok, response.text()]); })
                .then(([isSuccess, message]) => {

                    const remainingDelay = Math.max(0, TEMPO_ESPERA_SPINNER - (Date.now() - startTime));

                    setTimeout(() => {
                        spinnerCadastro.style.display = 'none';

                        if (isSuccess) { messageTitle.textContent = "✅ Cliente Cadastrado!"; messageTitle.className = 'text-success text-center'; }
                        else { messageTitle.textContent = "❌ Falha no Cadastro!"; messageTitle.className = 'text-danger text-center'; }
                        messageBody.textContent = message;
                        resultMessageDiv.style.display = 'flex';

                        setTimeout(() => {
                            modalCadastro.hide();
                            window.location.href = '/admin';
                        }, TEMPO_EXIBICAO_MENSAGEM);

                    }, remainingDelay);
                })
                .catch(error => {
                    console.error("Erro na Requisição:", error);
                    alert("Ocorreu um erro de conexão. Tente novamente.");
                    spinnerCadastro.style.display = 'none';
                    cadastroForm.style.display = 'block';
                    submitButton.disabled = false;
                });
            });

            // TRATAMENTO DOS EVENTOS DO MODAL DE CADASTRO (CORRIGE O MODAL EM BRANCO)
            modalElementCadastro.addEventListener('show.bs.modal', function () {
                cadastroForm.reset();
                spinnerCadastro.style.display = 'none';
                resultMessageDiv.style.display = 'none';
                cadastroForm.style.display = 'block';
                cadastroForm.querySelector('button[type="submit"]').disabled = false;
            });
            modalElementCadastro.addEventListener('hidden.bs.modal', function () {
                cadastroForm.reset();
                spinnerCadastro.style.display = 'none';
                resultMessageDiv.style.display = 'none';
                cadastroForm.style.display = 'block';
                cadastroForm.querySelector('button[type="submit"]').disabled = false;
            });
        }


        // =================================================================
        // 3. LÓGICA DE AUTOCOMPLETAR
        // =================================================================

        if (inputNomeCliente && divResultados) {
            inputNomeCliente.addEventListener('input', function() {
                 clearTimeout(searchTimeout);
                 const termo = this.value.trim();

                 if (termo.length < 2) { divResultados.style.display = 'none'; return; }

                 searchTimeout = setTimeout(() => {
                     fetch(`/api/clientes/buscar?termo=${encodeURIComponent(termo)}`)
                         .then(response => {
                             if (!response.ok) { throw new Error('Falha na API: ' + response.status); }
                             return response.json();
                         })
                         .then(clientes => {
                             divResultados.innerHTML = '';
                             if (Array.isArray(clientes) && clientes.length > 0) {
                                 clientes.forEach(cliente => {
                                     const item = document.createElement('a');
                                     item.href = '#';
                                     item.className = 'list-group-item list-group-item-action';
                                     item.textContent = `${cliente.nome} (${cliente.whatsapp})`;
                                     item.addEventListener('click', function(e) {
                                         e.preventDefault();
                                         inputNomeCliente.value = cliente.nome;
                                         divResultados.style.display = 'none';
                                     });
                                     divResultados.appendChild(item);
                                 });
                                 divResultados.style.display = 'block';
                             } else { divResultados.style.display = 'none'; }
                         })
                         .catch(error => {
                             console.error('Erro na busca de clientes:', error);
                             divResultados.style.display = 'none';
                         });
                 }, 300);
             });

            document.addEventListener('click', function(e) {
                if (e.target !== inputNomeCliente && e.target.parentNode !== divResultados) {
                    divResultados.style.display = 'none';
                }
            });
        }


        // =================================================================
        // 4. INICIALIZAÇÃO E LISTENERS GERAIS
        // =================================================================

        // Define a função toggleSidebar aqui (já que ela é pequena):
        const sidebarWidthOpen = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width-open').trim();
        const toggleSidebarFunction = () => {
             const isClosed = !body.classList.contains('sidebar-open');
             if (isClosed) {
                 body.classList.add('sidebar-open');
                 menuToggle.innerHTML = '<i class="bi bi-x-lg"></i>';
                 mainHeader.style.left = sidebarWidthOpen;
                 mainHeader.style.width = `calc(100% - ${sidebarWidthOpen})`;
             } else {
                 body.classList.remove('sidebar-open');
                 menuToggle.innerHTML = '<i class="bi bi-list"></i>';
                 mainHeader.style.left = sidebarWidthClosed;
                 mainHeader.style.width = `calc(100% - ${sidebarWidthClosed})`;
             }
         };

        menuToggle.addEventListener('click', toggleSidebarFunction);

        sidebarLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                const targetId = this.getAttribute('data-target');
                if (targetId) {
                    e.preventDefault();
                    let title = "Dashboard de Gerenciamento";
                    if (targetId === 'agendamentos-section') { title = "Lista Completa de Agendamentos"; }
                    else if (targetId === 'servicos-section') { title = "Catálogo de Serviços e Preços"; }
                    else if (targetId === 'fidelidade-section') { title = "Clientes e Controle de Fidelidade"; }
                    navigateToSection(targetId, title);
                }
            });
        });

        // ESTADO INICIAL
        body.classList.remove('sidebar-open');
        menuToggle.innerHTML = '<i class="bi bi-list"></i>';
        navigateToSection('dashboard-section', 'Dashboard de Gerenciamento');
        mainHeader.style.left = sidebarWidthClosed;
        // mainHeader.style.width = `calc(100% - ${sidebarWidthClosed})`; // Esta linha pode causar falhas visuais.

    });
</script>
</body>
</html>